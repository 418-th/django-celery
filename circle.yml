machine:

  python:
    version: 3.5.1

  node:
    version: 4.2.6

  services:
    - redis

dependencies:
  pre:
    - pip install --upgrade pip
    - chmod +x ./build/*.sh

  post:
    - npm install -g gulp bower
    - bower install
    - ./build/download_geoip_db.sh

  cache_directories:
    - ./node_modules/
    - ./elk/static/vendor/
    - ./geolite/

test:
  pre:
    - gulp production
    - cp elk/.env.circle elk/.env
    - ./manage.py migrate
    - find */fixtures -type f -name '*.yaml'|xargs ./manage.py loaddata

  post:
    - bash <(curl -s https://codecov.io/bash) -t 8ce25f6b-eaf8-442a-aab4-fb6218384b6e
    - ./build/store-build-information.sh
    - ./build/strip-for-production.sh
    - mv elk/.env elk/.env.circle

deployment:
  production:
    branch: master
    commands:
      - ssh deployer@128.199.32.70 /home/deployer/pre-deploy.sh production
      - rsync -vz --delete -rl ./ deployer@128.199.32.70:/home/dashboard/src/
      - ssh deployer@128.199.32.70 /home/deployer/post-deploy.sh production
